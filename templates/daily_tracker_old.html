{% extends "base.html" %}
{% block title %}Daily Tracker{% endblock %}
{% block content %}

<!-- All page styling placed here at top -->
<style>
  /* --- Checkbox --- */
  #entries_table th:nth-child(1),
  #entries_table td:nth-child(1) { width: 32px; }

  /* --- Date --- */
  #entries_table th:nth-child(3),
  #entries_table td:nth-child(3) { width: 90px; white-space: nowrap; }

  /* --- Task Type --- */
  #entries_table th:nth-child(6),
  #entries_table td:nth-child(6) { width: 60px; text-align: center; white-space: nowrap; }

  /* --- Time in min --- */
  #entries_table th:nth-child(7),
  #entries_table td:nth-child(7) { width: 90px; text-align: center; }

  /* --- Dropdown Styles --- */
  .custom-select-wrapper { position: relative; }
  .custom-select-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: #fff; border: 1px solid #ccc;
    max-height: 220px; overflow-y: auto;
    z-index: 1000; display: none;
  }
  .custom-select-option:hover, .custom-select-option.active {
    background: #003C71; color: #fff;
  }
  .custom-select-dropdown.show { display: block; }
  .custom-select-option { padding: 8px; cursor: pointer; }

  /* --- Layout & Grid --- */
  .content-card { padding: 12px; box-sizing: border-box; overflow-x: auto; }
  .dt-grid { display: grid; grid-template-columns: 200px 1fr 200px 1fr; gap: 12px; align-items: end; }
  .dt-grid label { display: block; margin-bottom: 6px; font-size: 13px; color: #222; }
  .dt-grid input[type="text"], .dt-grid input[type="date"], .dt-grid input[type="number"] {
    width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 14px;
  }

  /* --- Buttons --- */
  #add_btn { background-color: #0d6efd !important; color: #fff !important; border: none; }
  #add_btn[disabled], input[type="date"][disabled] { opacity: 0.6; cursor: not-allowed; }

  /* --- Table --- */
  #entries_table { width: 100%; border-collapse: collapse; border: 1px solid #cfcfcf; margin-top: 12px; table-layout: fixed; }
  #entries_table thead { background: #fafafa; }
  #entries_table th, #entries_table td {
    padding: 8px 6px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px;
    white-space: normal; word-break: break-word; overflow-wrap: anywhere;
  }
  #entries_table th:first-child, #entries_table td:first-child { width: 30px; text-align: center; }

  /* --- Actions & Aggregates --- */
  .actions-row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
  .copy-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid #bbb; background: #fff; cursor: pointer; }
  
  #aggregates_table { width: 100%; border-collapse: collapse; border: 1px solid #cfcfcf; margin-top: 12px; }
  #aggregates_table thead { background: #fafafa; }
  #aggregates_table th, #aggregates_table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
  
  #aggregates_table .btn-outline-primary {
    background: #fff !important; color: #000 !important; border: 1px solid #bbb !important; opacity: 1 !important;
  }
  #aggregates_table .btn-outline-primary:hover { background: #f5f5f5 !important; color: #000 !important; }
</style>

<div class="content-card">
  <h1 style="text-align:center;margin-bottom:8px;">Daily Tracker</h1>

  <div class="dt-grid">
    <div>
      <label for="entry_date">Select Date</label>
      <input id="entry_date" type="date">
    </div>

    <div class="custom-select-wrapper">
      <label>Customer</label>
      <input type="text" id="custSearch" placeholder="-- Select Customer --" autocomplete="off">
      <div id="custDropdown" class="custom-select-dropdown"></div>
      <input type="hidden" id="customer_select">
    </div>

    <div>
      <label for="time_in_min">Time in Min</label>
      <input type="number" id="time_in_min" placeholder="Time in Min" min="1" step="1"
             oninput="this.value = this.value.replace(/[^0-9]/g,'')">
    </div>

    <div class="custom-select-wrapper">
      <label>Select Task</label>
      <input type="text" id="taskSearch" placeholder="-- Select Task --" autocomplete="off">
      <div id="taskDropdown" class="custom-select-dropdown"></div>
      <input type="hidden" id="task_select">
    </div>

    <div style="grid-column:1 / span 3;">
      <label for="comments">Comments</label>
      <input id="comments" type="text" placeholder="Enter comments">
    </div>

    <div style="display:flex;align-items:center;justify-content:flex-end;">
      <button id="add_btn" class="btn btn-primary" disabled>Add</button>
    </div>
  </div>

  <div id="selected_date_display" style="margin:12px 0; font-weight:600; color:#003C71;"></div>

  <!-- Entries Table -->
  <div>
    <table id="entries_table">
      <thead>
        <tr>
          <th></th>
          <th>User</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Task</th>
          <th>Task Type</th>
          <th>Time in min</th>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Actions -->
  <div class="actions-row" style="display:flex; align-items:center; gap:20px; margin-top:12px;">
    <label style="margin-left:auto;"></label>
    <input id="copy_to_date" type="date" style="width:160px; display:none;" disabled>
    <button id="copy_btn" class="btn btn-primary small" disabled>Copy details</button>
    <button id="delete_btn" class="btn btn-danger smalldel" disabled>Delete</button>
  </div>

  <!-- Aggregates -->
  <div>
    <table id="aggregates_table">
      <thead>
        <tr><th>Type</th><th>Total Hours</th><th>Concatenated String</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- CSV Download -->
  <div class="actions-row" style="display:flex; align-items:center; gap:12px; margin-top:12px;">
    <label style="margin-left:auto;"></label>
    <label id="from_lbl" style="display:none;">From</label>
    <input type="date" id="archive_from_date" style="width:150px; display:none;">
    <label id="to_lbl" style="display:none;">To</label>
    <input type="date" id="archive_to_date" style="width:150px; display:none;">
    <button id="download_csv" class="btn btn-primary">Download CSV</button>
  </div>
</div>

<!-- Data Storage for Scripts -->
<script id="data-customers" type="application/json">
  {{ customers_list | tojson }}
</script>
<script id="data-tasks" type="application/json">
  {{ tasks_list | tojson }}
</script>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  
  // --- Alerts & Modals ---
  function showAlert(msg) {
    document.getElementById('alertMsg').textContent = msg;
    document.getElementById('alertModal').style.display = 'flex';
  }

  document.getElementById('alertOk').onclick = function () {
    document.getElementById('alertModal').style.display = 'none';
  };

  function showConfirm(msg, onYes) {
    document.getElementById('confirmMsg').textContent = msg;
    document.getElementById('confirmModal').style.display = 'flex';
    
    // Clear old listeners to avoid multiple fires
    const btnOk = document.getElementById('confirmOk');
    const btnCancel = document.getElementById('confirmCancel');
    
    btnOk.onclick = null;
    btnCancel.onclick = null;

    btnOk.onclick = function () {
      document.getElementById('confirmModal').style.display = 'none';
      onYes();
    };

    btnCancel.onclick = function () {
      document.getElementById('confirmModal').style.display = 'none';
    };
  }

  // --- Clipboard Helper ---
  function copyTextToClipboard(text) {
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
      return navigator.clipboard.writeText(text);
    }
    return new Promise(function(resolve, reject) {
      try {
        const ta = document.createElement('textarea');
        ta.style.position = 'fixed'; ta.style.left = '-9999px';
        ta.value = text;
        document.body.appendChild(ta);
        ta.select(); ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        if (ok) resolve(); else reject(new Error('execCommand returned false'));
      } catch (err) { reject(err); }
    });
  }

  // --- DOM Elements ---
  function qs(id){ return document.getElementById(id); }
  const entry_date = qs('entry_date');
  const customer_select = qs('customer_select');
  const task_select = qs('task_select');
  const time_in_min = qs('time_in_min');
  const comments = qs('comments');
  const add_btn = qs('add_btn');
  const entries_table_body = document.querySelector('#entries_table tbody');
  const delete_btn = qs('delete_btn');
  const copy_btn = qs('copy_btn');
  const copy_to_date = qs('copy_to_date');
  const download_csv = qs('download_csv');
  const aggregates_table_body = document.querySelector('#aggregates_table tbody');
  const from_lbl = document.getElementById('from_lbl');
  const to_lbl = document.getElementById('to_lbl');
  const archive_from = document.getElementById('archive_from_date');
  const archive_to = document.getElementById('archive_to_date');
  const selectedDateDisplay = document.getElementById('selected_date_display');

  // --- Data Loading ---
  const customers = JSON.parse(document.getElementById('data-customers').textContent || '[]');
  const tasks = JSON.parse(document.getElementById('data-tasks').textContent || '[]');

  let calendarShown = false;

  function updateSelectedDateLabel() {
    if (entry_date.value) {
      const d = entry_date.value.split('-'); 
      selectedDateDisplay.textContent = 'Selected Date: ' + d[2] + '-' + d[1] + '-' + d[0];
    } else {
      selectedDateDisplay.textContent = '';
    }
  }

  // --- Autocomplete ---
  function setupAutocomplete(inputId, dropdownId, hiddenId, data) {
    const input = document.getElementById(inputId);
    const dropdown = document.getElementById(dropdownId);
    const hidden = document.getElementById(hiddenId);
    let currentIndex = -1;

    function renderList(filter = '') {
      dropdown.innerHTML = '';
      currentIndex = -1;
      data.filter(d => d.toLowerCase().includes(filter.toLowerCase())).forEach((d, idx) => {
        const div = document.createElement('div');
        div.className = 'custom-select-option';
        div.textContent = d;
        div.addEventListener('mouseenter', () => {
          clearActive(); div.classList.add('active'); currentIndex = idx;
        });
        div.addEventListener('click', () => selectOption(div));
        dropdown.appendChild(div);
      });
      dropdown.classList.toggle('show', dropdown.children.length > 0);
    }

    function clearActive() {
      dropdown.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
    }

    function setActive(index) {
      const items = dropdown.children;
      if (!items.length) return;
      clearActive();
      currentIndex = (index + items.length) % items.length;
      const activeItem = items[currentIndex];
      activeItem.classList.add('active');
      activeItem.scrollIntoView({ block: 'nearest' });
    }

    function selectOption(el) {
      input.value = el.textContent;
      hidden.value = el.textContent;
      dropdown.classList.remove('show');
      validateForm();
    }

    input.addEventListener('click', e => { e.stopPropagation(); renderList(); });
    input.addEventListener('input', () => renderList(input.value));
    input.addEventListener('keydown', e => {
      if (e.key === 'ArrowDown') { e.preventDefault(); if (!dropdown.classList.contains('show')) renderList(); setActive(currentIndex + 1); }
      if (e.key === 'ArrowUp') { e.preventDefault(); setActive(currentIndex - 1); }
      if (e.key === 'Enter') { e.preventDefault(); if (currentIndex >= 0 && dropdown.children[currentIndex]) selectOption(dropdown.children[currentIndex]); }
      if (e.key === 'Escape') dropdown.classList.remove('show');
    });
    document.addEventListener('click', () => dropdown.classList.remove('show'));
  }

  setupAutocomplete('custSearch', 'custDropdown', 'customer_select', customers.map(c => c.label));
  setupAutocomplete('taskSearch', 'taskDropdown', 'task_select', tasks);

  // --- Form Logic ---
  function validateForm(){
    const ok = entry_date.value !== '' && customer_select.value !== '' &&
               task_select.value !== '' && comments.value.trim().length > 0 &&
               Number(time_in_min.value) >= 1;
    add_btn.disabled = !ok;
  }
  
  const formRoot = document.querySelector('.dt-grid');
  formRoot.addEventListener('input', validateForm);
  formRoot.addEventListener('change', validateForm);

  if (entry_date && !entry_date.value) {
    entry_date.value = new Date().toISOString().slice(0,10);
  }
  validateForm();

  // --- Table Operations ---
  function renderEntries(rows){
    entries_table_body.innerHTML = '';
    rows.forEach(row=>{
      const tr = document.createElement('tr');
      const cbTd = document.createElement('td'); cbTd.style.padding='6px';
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.className = 'form-check-input'; cb.value = row.id;
      cb.addEventListener('change', toggleActionButtons);
      cbTd.appendChild(cb); tr.appendChild(cbTd);

      ['userid','log_date','customername','taskname','task_type','time_in_min','comments'].forEach(k=>{
        const td = document.createElement('td'); td.style.padding='6px';
        td.textContent = row[k] || ''; tr.appendChild(td);
      });
      entries_table_body.appendChild(tr);
    });
    toggleActionButtons();
  }

  function loadEntries(){
    const date = entry_date.value;
    if(!date) return;
    fetch(`/daily_tracker/fetch_entries?date=${encodeURIComponent(date)}`)
      .then(r=>r.json()).then(data=>renderEntries(data.results || []))
      .catch(e=>console.error(e));
  }

  function toggleActionButtons(){
    const checked = document.querySelectorAll('#entries_table tbody input[type=checkbox]:checked');
    const has = checked.length > 0;
    delete_btn.disabled = !has;
    copy_btn.disabled = !has;
    copy_to_date.style.display = 'none';
    copy_to_date.disabled = true;
    copy_to_date.value = '';
  }

  // --- Event Listeners ---
  add_btn.addEventListener('click', function () {
    const payload = {
      date: entry_date.value,
      customer: customer_select.value.trim(),
      task: task_select.value.trim(),
      time_in_min: parseInt(time_in_min.value, 10),
      comments: comments.value.trim()
    };
    fetch('/daily_tracker/add', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(resp => {
      if (resp.success) {
        task_select.selectedIndex = 0; qs('taskSearch').value = ''; 
        comments.value = ''; time_in_min.value = '';
        validateForm(); loadEntries(); loadAggregates();
        showAlert('Saved Successfully');
      } else {
        showAlert(resp.message || 'Failed to add entry');
      }
    }).catch(err => { console.error(err); showAlert('Add failed'); });
  });

  delete_btn.addEventListener('click', function () {
    const ids = Array.from(document.querySelectorAll('#entries_table tbody input[type=checkbox]:checked')).map(i => i.value);
    if (!ids.length) return;
    showConfirm('Delete selected entries?', function () {
      fetch('/daily_tracker/delete', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
      }).then(r => r.json()).then(resp => {
        if (resp.success) {
          loadEntries(); loadAggregates(); showAlert('Deleted Successfully');
        } else { showAlert(resp.message || 'Delete failed.'); }
      });
    });  
  });

  copy_btn.addEventListener('click', function(){
    if (copy_to_date.style.display !== 'none' && !copy_to_date.value) {
      copy_to_date.style.display = 'none'; copy_to_date.disabled = true; copy_to_date.value = '';
      return;
    }
    copy_to_date.style.display = 'inline-block';
    copy_to_date.disabled = false;
    copy_to_date.focus();
    if (!copy_to_date.value) return;

    const ids = Array.from(document.querySelectorAll('#entries_table tbody input[type=checkbox]:checked')).map(i=>i.value);
    fetch('/daily_tracker/copy', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids: ids, target_date: copy_to_date.value })
    }).then(r=>r.json()).then(resp=>{
      if(resp.success) {
        showAlert('Copied Successfully');
        loadEntries(); loadAggregates();
        copy_to_date.style.display = 'none'; copy_to_date.value = '';
      } else { showAlert(resp.message || 'Copy failed.'); }
    });
  });

  download_csv.addEventListener('click', function () {
    if (calendarShown && !archive_from.value) {
      calendarShown = false;
      from_lbl.style.display = 'none'; to_lbl.style.display = 'none';
      archive_from.style.display = 'none'; archive_to.style.display = 'none';
      archive_from.value = ''; archive_to.value = '';
      return;
    }
    if (!calendarShown) {
      from_lbl.style.display = 'inline'; to_lbl.style.display = 'inline';
      archive_from.style.display = 'inline-block'; archive_to.style.display = 'inline-block';
      archive_to.value = new Date().toISOString().slice(0, 10);
      calendarShown = true; archive_from.focus();
      return;
    }
    if (!archive_from.value) { showAlert('Please select From Date'); archive_from.focus(); return; }
    if (archive_from.value > archive_to.value) { showAlert('From Date cannot be after To Date'); return; }
    
    window.location.href = `/daily_tracker/download_csv?from=${encodeURIComponent(archive_from.value)}&to=${encodeURIComponent(archive_to.value)}`;
    calendarShown = false;
    from_lbl.style.display = 'none'; to_lbl.style.display = 'none';
    archive_from.style.display = 'none'; archive_to.style.display = 'none';
    archive_from.value = '';
  });

  function loadAggregates(){
    const date = entry_date.value;
    if(!date) return;
    fetch(`/daily_tracker/aggregates?date=${encodeURIComponent(date)}`)
      .then(r=>r.json()).then(data=>{
        aggregates_table_body.innerHTML = '';
        (data.rows||[]).forEach(r=>{
          const tr = document.createElement('tr');
          const tdType = document.createElement('td'); tdType.style.padding='6px'; tdType.textContent = r.type; tr.appendChild(tdType);
          const tdTotal = document.createElement('td'); tdTotal.style.padding='6px'; tdTotal.textContent = r.total_hours; tr.appendChild(tdTotal);
          const tdConcat = document.createElement('td'); tdConcat.style.padding='6px';
          tdConcat.style.whiteSpace='normal'; tdConcat.style.wordBreak = 'break-word'; tdConcat.style.overflowWrap = 'anywhere';
          tdConcat.textContent = r.concatenated_string || ''; tr.appendChild(tdConcat);
          
          const tdBtn = document.createElement('td'); tdBtn.style.padding='6px';
          const copyBtn = document.createElement('button');
          copyBtn.textContent='Copy'; copyBtn.className = 'btn btn-outline-primary btn-sm';
          copyBtn.addEventListener('click', function(){
            copyTextToClipboard(r.concatenated_string || '').then(()=> showAlert('Copied to clipboard'))
              .catch(() => showAlert('Copy failed â€” try Ctrl+C'));
          });
          tdBtn.appendChild(copyBtn); tr.appendChild(tdBtn);
          aggregates_table_body.appendChild(tr);
        });
      });
  }

  updateSelectedDateLabel();
  loadEntries();
  loadAggregates();
  entry_date.addEventListener('change', ()=> { updateSelectedDateLabel(); loadEntries(); loadAggregates(); });
});
</script>

<!-- ALERT MODAL -->
<div id="alertModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:100000; align-items:center; justify-content:center;">
  <div style="background:#fff; width:420px; border-radius:12px; padding:24px;">
    <h3>Alert</h3>
    <div id="alertMsg" style="margin-top:10px; padding:10px 0; font-size:14px;"></div>
    <div style="text-align:right; margin-top:20px;">
      <button id="alertOk" class="btn btn-primary">OK</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:100000; align-items:center; justify-content:center;">
  <div style="background:#fff; width:420px; border-radius:12px; padding:24px;">
    <h3>Confirm</h3>
    <div id="confirmMsg"></div>
    <div style="text-align:right; margin-top:20px;">
      <button id="confirmCancel" class="btn btn-danger">Cancel</button>
      <button id="confirmOk" class="btn btn-primary">OK</button>
    </div>
  </div>
</div>

{% endblock %}