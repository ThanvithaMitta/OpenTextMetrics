{% extends "base.html" %}

{% block content %}
<style>
    /* 1. Input Placeholders (Text Inputs) */
    input::placeholder, textarea::placeholder {
        color: #888;
        font-style: italic;
        opacity: 1; /* Firefox fix */
    }

    /* 2. Select Dropdown Placeholder State (Unselected) */
    select.select-placeholder {
        color: #888 !important;
        font-style: italic !important;
    }

    /* 3. Normal Options inside Dropdown */
    select option {
        color: #333;
        font-style: normal;
    }

    /* 4. Select Dropdown Selected State (Value chosen) */
    select:not(.select-placeholder) {
        color: #333 !important;
        font-style: normal !important;
    }
</style>

<div class="content-card">
    <h1>Reporting</h1>

    <!-- 1. View Selection (Radio Buttons) -->
    <div class="radio-group">
        <label>
            <input type="radio" name="rptMode" value="cust" checked onclick="toggleMode()"> 
            Customer
        </label>
        <label>
            <input type="radio" name="rptMode" value="csm" onclick="toggleMode()"> 
            CSM
        </label>
    </div>

    <!-- 2. Filter Bar (Fixed Layout) -->
    <div class="filter-grid-4">
        
        <!-- Customer Dropdown (Visible by default) -->
        <div id="divCust" class="form-group custom-select-wrapper">
            <label>Customer</label>
            <input type="text" id="custSearch" class="custom-select-input" placeholder="-- Select Customer --" autocomplete="off">
            <span class="custom-select-arrow">â–¼</span>
            <div id="custDropdown" class="custom-select-dropdown"></div>
            <input type="hidden" id="rptShortCode">
        </div>

        <!-- CSM Dropdown (Hidden by default) -->
        <div id="divCsm" class="form-group hidden">
            <label>CSM</label>
            <select id="rptCsmSelect" class="form-control select-placeholder">
                <option value="" selected disabled hidden>-- Select CSM --</option>
            </select>
        </div>

        <!-- Month Dropdown -->
        <div class="form-group">
            <label>Month</label>
            <select id="rptMonth" class="form-control select-placeholder">
                <option value="" selected disabled hidden>Select Customer/CSM First</option>
            </select>
        </div>

        <!-- Previous Months (Custom Range) -->
        <div class="form-group">
            <label>Previous Months</label>
            <div id="rptRangeContainer">
                <select id="rptRangeSelect" class="form-control">
                    <option value="1">1</option>
                    <option value="3">3</option>
                    <option value="6" selected>6</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="number" id="rptRangeInput" class="form-control" style="display:none;" placeholder="Enter no. of months" min="1" max="60">
            </div>
        </div>

        <!-- Load Button -->
        <div class="form-group">
            <button class="btn btn-primary" onclick="loadReport()" style="height: 38px; width: 100%;">Load</button>
        </div>
    </div>

    <!-- 3. Historical Data Table -->
    <div id="reportSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:10px;">
            <h2 style="margin:0; font-size: 20px; color: #003C71;">Historical Data</h2>
            <button class="btn btn-primary" onclick="downloadCSV()">Download CSV</button>
        </div>

        <div class="report-table-container">
            <div class="table-scroll">
                <table id="reportTable" class="report-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. Manage Records Section (Inline Version) -->
    <div class="admin-section">
        <h2 style="color:#003C71;">Manage Records</h2>
        <div class="admin-buttons">
            <button class="btn btn-primary" onclick="toggleInsertPanel()">Add New Customer</button>
            <button class="btn btn-primary" onclick="toggleAuditPanel()">Audit Records</button>
        </div>

        <!-- INLINE INSERT PANEL (Hidden by default) -->
        <div id="insertPanel" style="display:none; background:#f9fbfd; padding:25px; border-radius:8px; border:1px solid #e0e0e0; margin-bottom:30px; margin-top:20px;">
            <h3 style="color:#003C71; margin-bottom:20px;">Insert New Record</h3>
            
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #ddd;">
                <h4 style="color:#003C71; border-bottom:2px solid #003C71; padding-bottom:10px; margin-bottom:20px;">Primary Configuration</h4>
                
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 20px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Customer Short Code <span style="color: red">*</span></label>
                        <input type="text" id="new_sc" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Go Live <span style="color: red">*</span></label>
                        <input type="date" id="new_golive" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>CSM Primary</label>
                        <input type="text" id="new_prim" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>CSM Lead</label>
                        <input type="text" id="new_lead" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>No of Months</label>
                        <input type="number" id="new_mon" value="6" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>No of Environments</label>
                        <select id="new_env" class="form-control">
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveNewCustomer()">Save Configuration</button>
                </div>
            </div>
        </div>

        <!-- INLINE AUDIT PANEL (Hidden by default) -->
        <div id="auditPanel" style="display:none; margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <h3 style="color:#003C71; margin:0;">Audit Records</h3>
                    <p style="font-size:13px; color:#666; margin:5px 0 0 0;">Showing latest 10 records</p>
                </div>
                <button class="btn btn-primary" onclick="downloadAuditCsv()">Download CSV</button>
            </div>

            <div class="report-table-container">
                <div class="table-scroll">
                    <table id="auditTable" class="report-table">
                        <thead>
                            <tr>
                                <th>Audit ID</th>
                                <th>Table Name</th>
                                <th>Operation</th>
                                <th>Changed At</th>
                                <th>System Name</th>
                                <th>User Name</th>
                                <th>Old Data</th>
                                <th>New Data</th>
                                <th>Primary Key</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let customers = [];

// Helper: Toggle Placeholder Class for Selects
function updateSelectPlaceholder(id) {
    const el = $(id);
    if (!el.val() || el.val() === "") {
        el.addClass('select-placeholder');
    } else {
        el.removeClass('select-placeholder');
    }
}

$('#custSearch').on('click input', function (e) {
    e.stopPropagation();  
    const val = $(this).val().toLowerCase();
    
    // --- CLEAR DATA IF EMPTY ---
    if ($(this).val().trim() === "") {
        $('#rptShortCode').val('');
        $('#rptMonth').empty().append('<option value="" selected disabled hidden>Select Customer/CSM First</option>');
        $('#rptMonth').addClass('select-placeholder'); // Reset style
        $('#reportSection').addClass('hidden'); // Clear the loaded table
    }
    // ---------------------------

    const dd = $('#custDropdown');
    dd.empty();

    const filtered = customers.filter(c =>
        c.display.toLowerCase().includes(val)
    );

    if (!filtered.length) {
        dd.append('<div class="custom-select-option disabled">No results</div>');
    } else {
        filtered.forEach(c => {
            dd.append(`
            <div class="custom-select-option"
                data-code="${c.short_code}"
                data-display="${c.display}">
                ${c.display}
            </div>
            `);
        });
    }

    dd.addClass('show');
});

$(document).on('mousedown', '.custom-select-option', function (e) {
    e.preventDefault();      
    e.stopPropagation();

    const code = $(this).data('code');
    const display = $(this).data('display');

    $('#custSearch').val(display);
    $('#rptShortCode').val(code);
    $('#custDropdown').removeClass('show');

    loadMonths(code, null);
});

$(document).ready(function() {

    // 1. RELOAD DETECTION
    if (performance.navigation.type === 1 || (window.performance.getEntriesByType && window.performance.getEntriesByType("navigation")[0] && window.performance.getEntriesByType("navigation")[0].type === 'reload')) {
       
        sessionStorage.removeItem('rpt_mode');
        sessionStorage.removeItem('rpt_month');
        sessionStorage.removeItem('rpt_range');
        sessionStorage.removeItem('rpt_short_code');
        sessionStorage.removeItem('rpt_cust_display');
        sessionStorage.removeItem('rpt_csm');
    }
 
    // 2. Fetch Data
    $.get('/api/customers', function(data) { customers = data; });
    $.get('/api/reporting/csm_list', function(data) {
        data.forEach(c => $('#rptCsmSelect').append(`<option value="${c}">${c}</option>`));
       
        restoreReportingState();
    });
 
    // ... Event Handlers ...
    $('#rptRangeSelect').change(function() {
        if ($(this).val() === 'custom') {
            $(this).hide();
            $('#rptRangeInput').show().val('').focus(); 
        }
    });

    $('#rptRangeInput').blur(function() {
        if ($(this).val() === '') {
            $(this).hide();
            $('#rptRangeSelect').val('6').show(); 
        }
    });

    // Style Toggles on Change
    $('#rptCsmSelect').change(function() {
        updateSelectPlaceholder('#rptCsmSelect');
        loadMonths(null, $(this).val());
    });

    $('#rptMonth').change(function() {
        updateSelectPlaceholder('#rptMonth');
    });

    restoreReportingState();

    $(document).on('click', function (e) {
        if (!$(e.target).closest('#divCust').length) {
            $('#custDropdown').removeClass('show');
        }
    });
});


function restoreReportingState() {
    const saved = sessionStorage.getItem('reporting_state');
    if (!saved) return;

    const state = JSON.parse(saved);
    
    // Restore Mode
    $(`input[name="rptMode"][value="${state.mode}"]`).prop('checked', true);
    toggleMode(); 

    // Restore Inputs
    if (state.mode === 'cust') {
        $('#custSearch').val(state.customerDisplay);
        $('#rptShortCode').val(state.customer);
        loadMonths(state.customer, null);
    } else {
        $('#rptCsmSelect').val(state.csm);
        updateSelectPlaceholder('#rptCsmSelect'); // Update style
        loadMonths(null, state.csm);
    }

    // Restore Range
    if (state.range === 'custom' || ![1,3,6].includes(parseInt(state.range))) {
        $('#rptRangeSelect').val('custom').change();
        $('#rptRangeInput').val(state.range);
    } else {
        $('#rptRangeSelect').val(state.range);
    }

    // Restore Table
    setTimeout(() => {
        $('#rptMonth').val(state.month);
        updateSelectPlaceholder('#rptMonth'); // Update style
        renderReportTable(state.data); 
    }, 500);
}

// View Toggle
function toggleMode() {
    const mode = $('input[name="rptMode"]:checked').val();
    if(mode === 'cust') {
        $('#divCust').removeClass('hidden');
        $('#divCsm').addClass('hidden');
        $('#custSearch').val('');
        $('#rptShortCode').val('');
    } else {
        $('#divCust').addClass('hidden');
        $('#divCsm').removeClass('hidden');
        $('#rptCsmSelect').val('');
        updateSelectPlaceholder('#rptCsmSelect'); // Reset style
    }
    $('#rptMonth').empty().append('<option value="" selected disabled hidden>Select Customer/CSM First</option>');
    $('#rptMonth').addClass('select-placeholder'); // Reset style
    $('#reportSection').addClass('hidden');
}

// Select Customer
function selectRptCust(code, display) {
    $('#custSearch').val(display);
    $('#rptShortCode').val(code);
    $('#custDropdown').removeClass('show');
    loadMonths(code, null);
}

// Load Months
function loadMonths(sc, csm, callback) {
    let url = '/api/reporting/months?';
    if(sc) url += 'short_code=' + sc;
    else if(csm) url += 'csm=' + csm;
    else return;
 
    const sel = $('#rptMonth');
    sel.empty().append('<option>Loading...</option>');
    sel.addClass('select-placeholder'); // Ensure italic while loading/resetting
 
    $.get(url, function(data) {
        sel.empty();
        sel.append('<option value="" selected disabled hidden>-- Select Month --</option>');
        if(data.length === 0) sel.append('<option value="" disabled>No data available</option>');
        else {
            data.forEach(m => {
                sel.append(`<option value="${m.value}">${m.display}</option>`);
            });
        }
        sel.val("");
        updateSelectPlaceholder('#rptMonth'); // Update style
       
        // Execute callback
        if (callback) callback();
    });
}

function getSelectedRange() {
    if ($('#rptRangeInput').is(':visible') && $('#rptRangeInput').val()) {
        return $('#rptRangeInput').val();
    }
    return $('#rptRangeSelect').val();
}

// Load Report
function loadReport() {
    const mode = $('input[name="rptMode"]:checked').val();
    const rangeVal = getSelectedRange();
    const month = $('#rptMonth').val();
   
    if (!rangeVal) { showAlert("Please specify previous months."); return; }
 
    const data = { month: month, range: rangeVal };
    if(mode === 'cust') data.short_code = $('#rptShortCode').val();
    else data.csm = $('#rptCsmSelect').val();
 
    // --- VALIDATION ---
    if (mode === 'cust' && !data.short_code) {
        showAlert("Please select a Customer.");
        return;
    }
    if (mode === 'csm' && !data.csm) {
        showAlert("Please select a CSM.");
        return;
    }
    if (!data.month) {
        showAlert("Please select a Month.");
        return;
    }
    // ------------------
 
    // --- SAVE STATE ---
    sessionStorage.setItem('rpt_mode', mode);
    sessionStorage.setItem('rpt_month', month);
    sessionStorage.setItem('rpt_range', rangeVal);
   
    if(mode === 'cust') {
        sessionStorage.setItem('rpt_short_code', data.short_code);
        sessionStorage.setItem('rpt_cust_display', $('#custSearch').val());
    } else {
        sessionStorage.setItem('rpt_csm', data.csm);
    }
    // ------------------
 
    $.post('/load_report_data', data, function(res) {
        if(!res.success) { showAlert("Error loading report"); return; }
        renderReportTable(res.data);
    });
}

function saveReportingState(data) {
    const state = {
        mode: $('input[name="rptMode"]:checked').val(),
        customer: $('#rptShortCode').val(),
        customerDisplay: $('#custSearch').val(),
        csm: $('#rptCsmSelect').val(),
        month: $('#rptMonth').val(),
        range: getSelectedRange(),
        data: data
    };
    sessionStorage.setItem('reporting_state', JSON.stringify(state));
}

// Render Table
function renderReportTable(rows) {
    $('#reportSection').removeClass('hidden');
    const thead = $('#reportTable thead');
    const tbody = $('#reportTable tbody');
    thead.empty(); tbody.empty();

    if (rows.length === 0) {
        tbody.append('<tr><td colspan="10" style="text-align:center;">No Data Found</td></tr>');
        return;
    }

    const desiredOrder = [
        "Customer Name", "Month & Year", "CSM Primary", "CSM Lead", 
        "Availability (%)", "Target (%)", "Prod Limit", "Prod Used", 
        "Test Limit", "Test Used", "Dev Limit", "Dev Used", 
        "Prod Target GB", "Prod Actual GB", 
        "Test Target GB", "Test Actual GB", 
        "Dev Target GB", "Dev Actual GB", 
        "Opened Tickets", "Closed Tickets", 
        "Current Backlog Tickets", "Tickets Backlog"
    ];

    const availableKeys = Object.keys(rows[0]);
    const finalColumns = desiredOrder.filter(col => availableKeys.includes(col));

    let hRow = '<tr>';
    finalColumns.forEach(k => { hRow += `<th>${k}</th>`; });
    thead.append(hRow + '</tr>');

    rows.forEach(r => {
        let bRow = '<tr>';
        finalColumns.forEach(k => {
            let val = r[k] === null || r[k] === undefined ? '' : r[k];
            bRow += `<td>${val}</td>`;
        });
        tbody.append(bRow + '</tr>');
    });
}

// Download CSV
function downloadCSV() {
    const mode = $('input[name="rptMode"]:checked').val();
    const rangeVal = getSelectedRange();
    let form = $('<form action="/download_report_csv" method="post"></form>');
    form.append(`<input name="month" value="${$('#rptMonth').val()}">`);
    form.append(`<input name="range" value="${rangeVal}">`);
    if(mode === 'cust') form.append(`<input name="short_code" value="${$('#rptShortCode').val()}">`);
    else form.append(`<input name="csm" value="${$('#rptCsmSelect').val()}">`);
    $('body').append(form);
    form.submit();
    form.remove();
}

// Admin Panels
function toggleInsertPanel() {
    $('#auditPanel').hide(); 
    $('#insertPanel').slideToggle();
}
function toggleAuditPanel() {
    $('#insertPanel').hide(); 
    if ($('#auditPanel').is(':visible')) {
        $('#auditPanel').slideUp();
    } else {
        loadAuditData(); 
        $('#auditPanel').slideDown();
    }
}

function saveNewCustomer() {
    if(!$('#new_sc').val() || !$('#new_golive').val()) { showAlert("Required fields missing."); return; }
    
    $.post('/add_customer', {
        short_code: $('#new_sc').val(),
        go_live_date: $('#new_golive').val(),
        csm_primary: $('#new_prim').val(),
        csm_lead: $('#new_lead').val(),
        no_of_months: $('#new_mon').val(),
        no_of_environments: $('#new_env').val()
    }, function(res) {
        if(res.success) { 
            showAlert("Customer Added Successfully"); 
            $('#new_sc').val(''); $('#new_golive').val('');
            $('#insertPanel').slideUp();
            $.get('/api/customers', function(data) { customers = data; });
        } else { showAlert(res.message); }
    });
}

function loadAuditData() {
    $.get('/api/audits', function(rows) {
        const tb = $('#auditTable tbody');
        tb.empty();
        if (!rows || rows.length === 0) {
            tb.append('<tr><td colspan="9" style="text-align:center">No records found</td></tr>');
            return;
        }
        rows.forEach(r => {
            // Helper: Compact JSON string
            const formatData = (data) => {
                if (!data) return '-';
                try {
                    // CHANGED: Removed arguments to make it compact
                    return JSON.stringify(data); 
                } catch (e) {
                    return data;
                }
            };
 
            tb.append(`<tr>
            <td>${r.audit_id || ''}</td>
            <td>${r.table_name || ''}</td>
            <td>${r.operation_type || ''}</td>
            <td style="white-space:nowrap;">${r.changed_at || ''}</td>
            <td>${r.system_name || ''}</td>
            <td>${r.username || ''}</td>
            <td>
            <div class="audit-wrap-box">${formatData(r.old_data)}</div>
            </td>
            <td>
            <div class="audit-wrap-box">${formatData(r.new_data)}</div>
            </td>
            <td>${formatData(r.primary_key_value)}</td> 
            <td>
            <div class="audit-wrap-box">${r.comments || ''}</div>
            </td>
            </tr>`);
        });
    });
}

function downloadAuditCsv() {
    window.location.href = '/download_audits';
}

function enableKeyboardDropdown(inputId, dropdownId, onSelect) {
    let activeIndex = -1;

    const input = document.getElementById(inputId);
    const dropdown = document.getElementById(dropdownId);

    input.addEventListener('keydown', function (e) {
        const options = dropdown.querySelectorAll('.custom-select-option');
        if (!options.length) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = (activeIndex + 1) % options.length;
        } 
        else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = (activeIndex - 1 + options.length) % options.length;
        } 
        else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0) options[activeIndex].click();
            return;
        }

        options.forEach(o => o.classList.remove('active'));
        if (activeIndex >= 0) {
            options[activeIndex].classList.add('active');
            options[activeIndex].scrollIntoView({ block: 'nearest' });
        }
    });

    dropdown.addEventListener('mouseover', () => activeIndex = -1);
}

</script>
{% endblock %}